<?xml version="1.0"?>
<!-- Copyright 2016 Yahoo Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root. -->

<project name="osgi-bundles" default="build" basedir=".">

  <property name="build.compiler" value="extJavac"/>

  <target name="archiveOsgiBundle">
    <property name="MANIFEST" value="target/build/manifest.mf"/>
    <copy file="src/test/java/${package}/${name}/Manifest.MF"
          tofile="${MANIFEST}"
          overwrite="true">
    </copy>

    <delete dir="staging"/>
    <mkdir dir="staging"/>
    <mkdir dir="target/test-classes"/> <!-- Create test-classes, does not exist during clover testing -->
    <copy todir="staging">
      <fileset dir="target/test-classes" includes="${package}/${name}/**"/>
    </copy>

    <mkdir dir="bundles"/>
    <jar jarfile="bundles/${name}bundle.jar"
         basedir="staging"
         manifest="${MANIFEST}"
         includes="**"
         index="true"
         />

    <delete file="${MANIFEST}"/>
  </target>

  <target name="archiveOsgiBundleVersion">
    <delete dir="staging"/>
    <mkdir dir="staging"/>

    <copy todir="staging">
      <fileset dir="src/test/java" includes="${package}/${name}-${version}/**"/>
    </copy>

    <!-- Remove version constraints imposed by developer tools/java -->
    <!-- Correct directory name to match package -->
    <move file="staging/${package}/${name}-${version}" todir="staging/${package}/${name}"/>
    <!-- Make source files .java -->
    <move todir="staging/${package}/${name}" includeemptydirs="false">
      <fileset dir="staging/${package}/${name}"/>
      <mapper type="glob" from="*.java.text" to="*.java"/>
    </move>

    <antcall target="compile">
      <param name="SOURCEPATH" value="staging"/>
      <param name="CLASSES_DIR" value="staging"/>
    </antcall>

    <mkdir dir="bundles"/>
    <jar jarfile="bundles/${name}bundle-${version}.jar"
         basedir="staging"
         manifest="src/test/java/${package}/${name}-${version}/Manifest.MF"
         includes="**"
         excludes="**/*.java"
         index="true"
         />
  </target>


  <!-- =================================================================== -->
  <!-- Creates the class jar archive                                       -->
  <!-- =================================================================== -->
  <target name="build"
          description="Jars the osgi bundles produced by this">
    <antcall target="archiveOsgiBundle">
      <param name="name" value="client"/>
      <param name="package" value="com/yahoo/osgi/test"/>
    </antcall>
    <antcall target="archiveOsgiBundle">
      <param name="name" value="calculatorservice"/>
      <param name="package" value="com/yahoo/osgi/test"/>
    </antcall>
    <antcall target="archiveOsgiBundle">
      <param name="name" value="counterservice"/>
      <param name="package" value="com/yahoo/osgi/test"/>
    </antcall>
    <antcall target="archiveOsgiBundle">
      <param name="name" value="searcher2"/>
      <param name="package" value="com/yahoo/search/searchchain/config/test"/>
    </antcall>
    <antcall target="archiveOsgiBundle">
      <param name="name" value="twosearchers"/>
      <param name="package" value="com/yahoo/search/searchchain/config/test"/>
    </antcall>
    <antcall target="archiveOsgiBundle">
      <param name="name" value="searcher1"/>
      <param name="package" value="com/yahoo/search/searchchain/config/test"/>
    </antcall>
    <antcall target="archiveOsgiBundleVersion">
      <param name="name" value="searcher1"/>
      <param name="package" value="com/yahoo/search/searchchain/config/test"/>
      <param name="version" value="2"/>
    </antcall>
    <antcall target="archiveOsgiBundleVersion">
      <param name="name" value="searcher1"/>
      <param name="package" value="com/yahoo/search/searchchain/config/test"/>
      <param name="version" value="2.1"/>
    </antcall>
    <antcall target="archiveOsgiBundleVersion">
      <param name="name" value="searcher1"/>
      <param name="package" value="com/yahoo/search/searchchain/config/test"/>
      <param name="version" value="2.2"/>
    </antcall>
    <antcall target="archiveOsgiBundle">
      <param name="name" value="updatesearcher"/>
      <param name="package" value="com/yahoo/search/searchchain/config/test"/>
    </antcall>
    <antcall target="archiveOsgiBundleVersion">
      <param name="name" value="updatesearcher"/>
      <param name="package" value="com/yahoo/search/searchchain/config/test"/>
      <param name="version" value="2"/>
    </antcall>

  </target>

  <!-- =================================================================== -->
  <!-- Compiles the source code                                            -->
  <!-- =================================================================== -->
  <target name="compile"
          description="Compiles all source files in the project SOURCEPATH">
    <property name="PATTERN" value="*"/>
    <property name="DEBUG" value="true"/>
    <property name="OPTI" value="off"/>
    <javac srcdir="${SOURCEPATH}"
           includeantruntime="false"
           encoding="UTF-8"
           destdir="${CLASSES_DIR}"
           classpath="target/classes:${MVN_COMPILE_CLASSPATH}"
           debug="${DEBUG}"
           deprecation="off"
           includes="**/${PATTERN}*.java"
           source="1.5"
           target="1.5"
           optimize="${OPTI}">
      <compilerarg compiler="jikes" value="+Pno-effective-java" />
      <compilerarg compiler="jikes" value="+Pno-shadow" />
      <compilerarg compiler="jikes" value="+Pno-switchcheck" />
    </javac>
  </target>

</project>
